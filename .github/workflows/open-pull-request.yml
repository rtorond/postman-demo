name: Deploy on App Engine pull request

on:
  push:
    branches-ignore:
      - master
  pull_request:
    branches-ignore:
      - master

jobs:
  build:
    runs-on: ubuntu-18.04
    steps:
    - uses: actions/checkout@v2
    - name: Slug environment variables
      uses: rlespinasse/github-slug-action@1.1.0
    - name: Deploy [carts-service] to App Engine
      uses: actions-hub/gcloud@268.0.0
      env:
        PROJECT_ID: postman-demo-269812
        APPLICATION_CREDENTIALS: ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAicG9zdG1hbi1kZW1vLTI2OTgxMiIsCiAgInByaXZhdGVfa2V5X2lkIjogIjhhOWJhNTRhOGUzZWNiMzUzNGQ0NDhiZTE1MzUyMmJhNjhmZjJlNDgiLAogICJwcml2YXRlX2tleSI6ICItLS0tLUJFR0lOIFBSSVZBVEUgS0VZLS0tLS1cbk1JSUV2UUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktjd2dnU2pBZ0VBQW9JQkFRQ2wyOUg0WTVZNlRkL1JcbkJpVkVGWENNeVUyTy85ZmxKdnJuaWxYQSt5aU92Snp6SFBsb1oxcFRaNHBYWE1SanR6Q1A1S3NqV0R1azRrMzFcblozdnV1L3NaSHlpTytPUG5UeXZjQW9WU0p4d1lJZHBQMmV3d1JsQ0YyaUNDU2NsTlkzL1UxNE5sOXdkdzlYVW5cbk02NXRNUWNpd2M5VXBOek1sSFVyRnhQY0Ryd1FrZHRuV3NtNlBvSStCUHFoVUtsNnU0NmgxelpRaWhPV09hNW9cbnNCTk0xcVBsbEhKWjh2Wk40bHJXTDRYUGtOcFhPT25QdVMwNEx4aTUzT1dUNFROOUFtL2gwYjBDMjJ2SEJqS3NcbkhvZVBIMThGdDRLcXYxRWpFQnNmVXEzUWVoNndWQjRpdThkbmc5OThmLzl3b1poNGVWdmFUWnJOT24wQ2U1bG9cblZmYXh6ZG9CQWdNQkFBRUNnZ0VBQVQ3Nno0ek5NMktTRkdUb2NHYm5qYnhTZU5yWEtjNXNyTjl2bTZDYjJsTEdcbkxGcXEyeXNQdHQxR2E2bURvQ0g3NUVtRDBKRlFZNEdtNVd0ZFZ6SFhwRHJ2N2taQ2wvQ2tpSGtWTlZvVkFRd0VcbjFtbzFCU25FZ3k0RzlEQ0NhY1EyL3g3am81V0JQd1BEZ0dWb0dLYzF0VTQ4SVUwem1ibGFvTFhDS04zaG8xYWJcbk1ZMnhIMWdpZTFoUitWS2R4dTlhWlh1V0JDWkx4L0JnMEwzS1NLbG5pMFlhT0cwaTVxUFFIRTdNQmV6QVlnVlVcbld6aE9wVVJPY09ocEdaNzdiVXVjUndiUTUvZ0pQOVRST1VLR3RxcDFlbVpiR1lLL3lkYUZZRWxsSzB6d3VDTW9cbno0VGFOYjNtNEtNZVZzNlRnOGVWR2NhdjBwUUcvODNiMW9GcFpZdFNPUUtCZ1FET2tVVDBrb3RCZDlJQVNMQUtcbm5uU05pY0JiM0doMEVEbEU3bHZOUmxKb3ErMGRaTC9MSzladGRhZWczbWZqdTZ1d2pGVUdWbUV0NHVYaGVzcjhcbkIvNUgvNHBMYk1PcDVpV0pXOUI5ZGFJeERVNFdiVXlhOUZvQXlHU2RuR0hYK0ZUTzZ6aG14SDBraUxUVk1JNUNcbnBMZlMyRG1GT0dSRnJCMXRFNjdIZnFqWFNRS0JnUUROaktaeXpKYVlGbE01Q3RxZHdDT2Voa3NmeGtKMXZWWjBcbm8xdTB1TjJLOEZtYnVycC9mV1BvaE9XRVZNVU8yS2JmdEI5b0ltbVlNd25mODZMTURMenBuTlNhbjRoYUh5NGVcbitxZjkybGNHWmFHdjJLQTdwTWFsQ1kycmpDMlZqM1A4MlJJSm5odWxxZzQxYXVoazZubXRWWldnRjRhRGtldE5cbjJEMGlodXpVK1FLQmdBNFRsREZlY3lMbytXU1BqMytKd01PTWFaRlkrYjAvQmNnT3ZpN0U1Z1RBQW82SU9SR3RcblVSVndlUlhiVWhVUXl1aGpCOEJBenFxRDFjcUJ4YWRiSEJibjhSS212TWF0S2sycjlnODJudkRjeVQ5NS8waG5cbjhtSXZSYnYvMWlNVGh5UDZuNE5SVEgzYTJ3ZlVJVDJsWCtsOFZwOGZjcVhVenNTS0hOVDNhcVlSQW9HQUtZS1Vcbi9xd0lZWkJvb0NWci90MlZrK2NFOXRiQUJ5MEViNnVwMG5aZTd6Y1lzWlZsSW1mOUxERGlkUFgxa2NqNDhrWmFcbjdWbTl2Mm5YUGEzakc1Z2E4b2FrZk5GbzVPSlZHeFo5cEl0YWRjVkNnTk9ia0UvM2VjN1RHR2pIcitOM2hnR0VcblhnTGJESHFxUWVsa0l6VWkrM2xFTFQ5eS85RVJGdmhyYURTZFVXa0NnWUVBdEszNmlDVER5a2tBS09TV01Rd2ZcbktDbmNrZGE1ZkJFQnkxbytCemNWeG1PRDZGS3kwOFBRVzN0cm50UVgyYUF3eFp4NGhGMGZzTVZsdTF5RDgwTmhcbk9sbWE5czBJNElTMWtkVFltQ2ZucHRNSUtCWHozZUlhWHcvMU5KelJOdjZwQ0Zta2pjZHpwa3VXWDIzOE5XSlRcbm94Z2lNZ2QzNkZsbEFtLzFHQ3lva0RBPVxuLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLVxuIiwKICAiY2xpZW50X2VtYWlsIjogInBvc3RtYW4tZGVtby0yNjk4MTJAYXBwc3BvdC5nc2VydmljZWFjY291bnQuY29tIiwKICAiY2xpZW50X2lkIjogIjExMzE3NjI5MjQ3MjkwMjA3NDk2OCIsCiAgImF1dGhfdXJpIjogImh0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9vL29hdXRoMi9hdXRoIiwKICAidG9rZW5fdXJpIjogImh0dHBzOi8vb2F1dGgyLmdvb2dsZWFwaXMuY29tL3Rva2VuIiwKICAiYXV0aF9wcm92aWRlcl94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL29hdXRoMi92MS9jZXJ0cyIsCiAgImNsaWVudF94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL3JvYm90L3YxL21ldGFkYXRhL3g1MDkvcG9zdG1hbi1kZW1vLTI2OTgxMiU0MGFwcHNwb3QuZ3NlcnZpY2VhY2NvdW50LmNvbSIKfQo=
      with:
        args: app deploy services/carts/app.yaml --no-promote --version=${{ env.GITHUB_REF_SLUG }}
    - name: Comment Pull request
      if: github.event_name == 'pull_request'
      uses: thollander/actions-comment-pull-request@1.0.0
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        message: '[carts-service] available on https://${{ env.GITHUB_REF_SLUG }}-dot-carts-dot-postman-demo-269812.appspot.com'
    - name: Deploy [products-service] to App Engine
      uses: actions-hub/gcloud@268.0.0
      env:
        PROJECT_ID: postman-demo-269812
        APPLICATION_CREDENTIALS: ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAicG9zdG1hbi1kZW1vLTI2OTgxMiIsCiAgInByaXZhdGVfa2V5X2lkIjogIjhhOWJhNTRhOGUzZWNiMzUzNGQ0NDhiZTE1MzUyMmJhNjhmZjJlNDgiLAogICJwcml2YXRlX2tleSI6ICItLS0tLUJFR0lOIFBSSVZBVEUgS0VZLS0tLS1cbk1JSUV2UUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktjd2dnU2pBZ0VBQW9JQkFRQ2wyOUg0WTVZNlRkL1JcbkJpVkVGWENNeVUyTy85ZmxKdnJuaWxYQSt5aU92Snp6SFBsb1oxcFRaNHBYWE1SanR6Q1A1S3NqV0R1azRrMzFcblozdnV1L3NaSHlpTytPUG5UeXZjQW9WU0p4d1lJZHBQMmV3d1JsQ0YyaUNDU2NsTlkzL1UxNE5sOXdkdzlYVW5cbk02NXRNUWNpd2M5VXBOek1sSFVyRnhQY0Ryd1FrZHRuV3NtNlBvSStCUHFoVUtsNnU0NmgxelpRaWhPV09hNW9cbnNCTk0xcVBsbEhKWjh2Wk40bHJXTDRYUGtOcFhPT25QdVMwNEx4aTUzT1dUNFROOUFtL2gwYjBDMjJ2SEJqS3NcbkhvZVBIMThGdDRLcXYxRWpFQnNmVXEzUWVoNndWQjRpdThkbmc5OThmLzl3b1poNGVWdmFUWnJOT24wQ2U1bG9cblZmYXh6ZG9CQWdNQkFBRUNnZ0VBQVQ3Nno0ek5NMktTRkdUb2NHYm5qYnhTZU5yWEtjNXNyTjl2bTZDYjJsTEdcbkxGcXEyeXNQdHQxR2E2bURvQ0g3NUVtRDBKRlFZNEdtNVd0ZFZ6SFhwRHJ2N2taQ2wvQ2tpSGtWTlZvVkFRd0VcbjFtbzFCU25FZ3k0RzlEQ0NhY1EyL3g3am81V0JQd1BEZ0dWb0dLYzF0VTQ4SVUwem1ibGFvTFhDS04zaG8xYWJcbk1ZMnhIMWdpZTFoUitWS2R4dTlhWlh1V0JDWkx4L0JnMEwzS1NLbG5pMFlhT0cwaTVxUFFIRTdNQmV6QVlnVlVcbld6aE9wVVJPY09ocEdaNzdiVXVjUndiUTUvZ0pQOVRST1VLR3RxcDFlbVpiR1lLL3lkYUZZRWxsSzB6d3VDTW9cbno0VGFOYjNtNEtNZVZzNlRnOGVWR2NhdjBwUUcvODNiMW9GcFpZdFNPUUtCZ1FET2tVVDBrb3RCZDlJQVNMQUtcbm5uU05pY0JiM0doMEVEbEU3bHZOUmxKb3ErMGRaTC9MSzladGRhZWczbWZqdTZ1d2pGVUdWbUV0NHVYaGVzcjhcbkIvNUgvNHBMYk1PcDVpV0pXOUI5ZGFJeERVNFdiVXlhOUZvQXlHU2RuR0hYK0ZUTzZ6aG14SDBraUxUVk1JNUNcbnBMZlMyRG1GT0dSRnJCMXRFNjdIZnFqWFNRS0JnUUROaktaeXpKYVlGbE01Q3RxZHdDT2Voa3NmeGtKMXZWWjBcbm8xdTB1TjJLOEZtYnVycC9mV1BvaE9XRVZNVU8yS2JmdEI5b0ltbVlNd25mODZMTURMenBuTlNhbjRoYUh5NGVcbitxZjkybGNHWmFHdjJLQTdwTWFsQ1kycmpDMlZqM1A4MlJJSm5odWxxZzQxYXVoazZubXRWWldnRjRhRGtldE5cbjJEMGlodXpVK1FLQmdBNFRsREZlY3lMbytXU1BqMytKd01PTWFaRlkrYjAvQmNnT3ZpN0U1Z1RBQW82SU9SR3RcblVSVndlUlhiVWhVUXl1aGpCOEJBenFxRDFjcUJ4YWRiSEJibjhSS212TWF0S2sycjlnODJudkRjeVQ5NS8waG5cbjhtSXZSYnYvMWlNVGh5UDZuNE5SVEgzYTJ3ZlVJVDJsWCtsOFZwOGZjcVhVenNTS0hOVDNhcVlSQW9HQUtZS1Vcbi9xd0lZWkJvb0NWci90MlZrK2NFOXRiQUJ5MEViNnVwMG5aZTd6Y1lzWlZsSW1mOUxERGlkUFgxa2NqNDhrWmFcbjdWbTl2Mm5YUGEzakc1Z2E4b2FrZk5GbzVPSlZHeFo5cEl0YWRjVkNnTk9ia0UvM2VjN1RHR2pIcitOM2hnR0VcblhnTGJESHFxUWVsa0l6VWkrM2xFTFQ5eS85RVJGdmhyYURTZFVXa0NnWUVBdEszNmlDVER5a2tBS09TV01Rd2ZcbktDbmNrZGE1ZkJFQnkxbytCemNWeG1PRDZGS3kwOFBRVzN0cm50UVgyYUF3eFp4NGhGMGZzTVZsdTF5RDgwTmhcbk9sbWE5czBJNElTMWtkVFltQ2ZucHRNSUtCWHozZUlhWHcvMU5KelJOdjZwQ0Zta2pjZHpwa3VXWDIzOE5XSlRcbm94Z2lNZ2QzNkZsbEFtLzFHQ3lva0RBPVxuLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLVxuIiwKICAiY2xpZW50X2VtYWlsIjogInBvc3RtYW4tZGVtby0yNjk4MTJAYXBwc3BvdC5nc2VydmljZWFjY291bnQuY29tIiwKICAiY2xpZW50X2lkIjogIjExMzE3NjI5MjQ3MjkwMjA3NDk2OCIsCiAgImF1dGhfdXJpIjogImh0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9vL29hdXRoMi9hdXRoIiwKICAidG9rZW5fdXJpIjogImh0dHBzOi8vb2F1dGgyLmdvb2dsZWFwaXMuY29tL3Rva2VuIiwKICAiYXV0aF9wcm92aWRlcl94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL29hdXRoMi92MS9jZXJ0cyIsCiAgImNsaWVudF94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL3JvYm90L3YxL21ldGFkYXRhL3g1MDkvcG9zdG1hbi1kZW1vLTI2OTgxMiU0MGFwcHNwb3QuZ3NlcnZpY2VhY2NvdW50LmNvbSIKfQo=
      with:
        args: app deploy services/products/app.yaml --no-promote --version=${{ env.GITHUB_REF_SLUG }}
    - name: Comment Pull request
      if: github.event_name == 'pull_request'
      uses: thollander/actions-comment-pull-request@1.0.0
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        message: '[products-service] available on https://${{ env.GITHUB_REF_SLUG }}-dot-products-dot-postman-demo-269812.appspot.com'
    - name: Integration tests with Postman & Newman
      uses: mikeal/npx@master
      with:
        args: >-
          newman run test/postman-demo.postman_collection.json
          --env-var "cart-service-url=https://${{ env.GITHUB_REF_SLUG }}-dot-carts-dot-postman-demo-269812.appspot.com"
          --env-var "products-service-url=https://${{ env.GITHUB_REF_SLUG }}-dot-products-dot-postman-demo-269812.appspot.com"
