name: Deploy on App Engine pull request

on:
  push:
    branches-ignore:
      - master
  pull_request:
    branches-ignore:
      - master

jobs:
  build:
    runs-on: ubuntu-18.04
    steps:
    - uses: actions/checkout@v2
    - name: Slug environment variables
      uses: rlespinasse/github-slug-action@1.1.0
    - name: Deploy [carts-service] to App Engine
      uses: actions-hub/gcloud@268.0.0
      env:
        PROJECT_ID: postman-demo-269812
        APPLICATION_CREDENTIALS: ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAicG9zdG1hbi1kZW1vLTI2OTgxMiIsCiAgInByaXZhdGVfa2V5X2lkIjogIjU5Y2Y1MWQ4NzBlZjdlNzNlODcxZDdmOTA4YTQyMTU3NzE5YjhlYjMiLAogICJwcml2YXRlX2tleSI6ICItLS0tLUJFR0lOIFBSSVZBVEUgS0VZLS0tLS1cbk1JSUV2Z0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktnd2dnU2tBZ0VBQW9JQkFRRGRUdXBDOUpDamlSeUlcblIyYWdtYVFVZlM4UE5HM2ZzalYrOWJNbFkzQXVBM2lybzVGRjNGdVJxMCs5MjdpcXJjVEJCRy9xYjJuUmZDOVlcbkFOTnpxNk9ySm9jUE1QelR4MXhYZG00dmg3aUtEaDFKMWZPc2l0dWxWYklPTnA2Tll6TWdRL1FCbzl2bWgwMG9cbjVCMjR0L3gzT0RaUWtBaUxCTEZZUUtZR2lBMkxmbit1Mno5VWNLazQrUGkrR2tYYWd1MHVkWnc4S205NDVwbEhcbk0zL25kckRmWk82aC9RSUs2SVlzOVMvU2ZBL1hETzdiRExRUUpJZklqZlRjOGhGOGhWTTh1QldRa1NQeUlSUE1cbmN0QUsrb3BaUFExK0FCVEdCSjdjYWhEa2o3d2k3clNIczZGMW8xaHByRGx3YUt3SUFhVm4yV0wyODR3Tmp5UkZcblIwNFRQcDJKQWdNQkFBRUNnZ0VBTlJNZ05Qc010aCtqcDE1Q1UxbE5nN2xyQUJGQm1ZQ1dlbEtJQ25zdzArUXlcbnZDMGY0YnFCZm11d2xkYWNVTmlZUTNjaU5QM1B5YlRuOE1uUDdHRjVRTXBlWVNzTk0yZ1FNZ3lkeThuWG5NcGFcblJWTXBtNU40cmt2aFJpM2N0QWxhb1U0U3RwTDY0YXhJdWJvTms3ZVNOWEJXZkZjeXFVNXdqcnNBWmpnYVVYM01cbmczQ24wOCtMTFhPeDRmUm9VekhwV2hlRmRxemltWGk4dDRHUytQSCtjakE5QzJmRExvL2t3M1dvdklnTHVqUG1cbmZHMmpYZXY5dUd0aC9QUUd2cHRUWUJNeTVGckF2cVMwUTdGNkZZRzg1dS9KRGE2bXh2bnFZajJRam4wdDBmcVRcbkZkN25PNDJvbUtkQnlWczF6OWtWajVzUE5xOFY4WTBDSVp6S0RhSGV4UUtCZ1FEeng4bW1JbXRZSk1yVFlZQ0dcbkU1ZFQ4NyttbFVTUmp1d1hnR2Y2a1UrYWh4N2RGYUVOWXBLbE1jMmdrVE8yMGZmTXc4bDJsMHNRTnZGYmw5TW1cbndJWUlpM3JUTkhWMVg2cmh1L3FCbS9lTllDSVQ3bWZxMmhtOE05a2pZdGVtQnpwNlVYbWpPSmFLcStoY3J6WDdcbjNoSWloRmdabEllWk9DSDdhTU9HbHM2NHRRS0JnUURvWnNNN3VGVVdLbkdZdU5KWVJTNEZBNWhGSUEvQUtJOGZcblN0Qzl6MnFLZ3NIczlJOUpEMWFvejQrM2xLR0tMMGxNenZxeWkwTFkyR1NWRC9EVTB6Ymk4dFpjZ1VaTkwweFJcbkpLaXJLUnBsTVNnckRFZE1wQjBQOWVYRk5LWTc0cUlWOUx1N2NWa1R3ZkgvcERHSWRRcGVDZGN1K2xoOW5Lc0xcbjNmaEJRMnc2QlFLQmdRRExiYi8vVEIrcHVXSXNET1EwZm1xOG10NG1ROCtwYTh2bVBMZ0lKM1IzTGlSNk40OWlcbjNRd2tvQy9JdXdLZG9BK2FKeE9hUzl4TzFwcUlaV1RGcE1qMG5uaExnUzQzV1RML0ZsK1FBcmdNbU5rM0txNDdcbkUrOS8xd0J2QUErV3M5ZC90VGU5RmY3Q0QzeGl3NjlYMDlQc1MrWTh5bTV4Vko4KzdnaWo2bnJ0TlFLQmdHdzFcbnBRUUNrVU92NFpLOXc5c3I0d0NjcXVMTXllaXNPZS9WRXhxK0lCcDhSYldDTGRGVDNnTGVHa25kWDlZS3JIT2lcbkVDTGdLdkR5Mk9wN01LUzM3OTkrT0lkNy9mTGthZ0dDTXpMM0FYNUtoQ3gvSEJlNGRudS9BQXh4dGxFOTlrQ0lcbjRueWxpMWRpdjc1TGduREtKbGlnOWx1K1gwT2xsaE1CZUoxU3Vtck5Bb0dCQUxJbTIwL0xIekw5OTZ0WktIeWVcblhnV3lFKyt1WkhVTEE2a094STFRU1hoc0VrYkt2aDZvZ2RaS0JuZG9iNk1nWk9LbGxsaVVXcEk1TVh2YTMrY09cbjFCcXRrRkNaMy9kM1BGd0xXSnhpbm9nelgwcWg1cTUreUtPM2pTZ1BtSHlHVzkzempHKzZaa1JoZnR1UnNmckJcbi94dTVOUkZTNjIrRitsRWFCTVR1cmtnQ1xuLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLVxuIiwKICAiY2xpZW50X2VtYWlsIjogImFwcC1lbmdpbmUtZ2l0aHViYWN0aW9uc0Bwb3N0bWFuLWRlbW8tMjY5ODEyLmlhbS5nc2VydmljZWFjY291bnQuY29tIiwKICAiY2xpZW50X2lkIjogIjExNzAxNzE1MjI0MTAwMTA3OTM4NyIsCiAgImF1dGhfdXJpIjogImh0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9vL29hdXRoMi9hdXRoIiwKICAidG9rZW5fdXJpIjogImh0dHBzOi8vb2F1dGgyLmdvb2dsZWFwaXMuY29tL3Rva2VuIiwKICAiYXV0aF9wcm92aWRlcl94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL29hdXRoMi92MS9jZXJ0cyIsCiAgImNsaWVudF94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL3JvYm90L3YxL21ldGFkYXRhL3g1MDkvYXBwLWVuZ2luZS1naXRodWJhY3Rpb25zJTQwcG9zdG1hbi1kZW1vLTI2OTgxMi5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIKfQo=
      with:
        args: app deploy services/carts/app.yaml --no-promote --version=${{ env.GITHUB_REF_SLUG }}
    - name: Deploy [products-service] to App Engine
      uses: actions-hub/gcloud@268.0.0
      env:
        PROJECT_ID: postman-demo-269812
        APPLICATION_CREDENTIALS: ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAicG9zdG1hbi1kZW1vLTI2OTgxMiIsCiAgInByaXZhdGVfa2V5X2lkIjogIjU5Y2Y1MWQ4NzBlZjdlNzNlODcxZDdmOTA4YTQyMTU3NzE5YjhlYjMiLAogICJwcml2YXRlX2tleSI6ICItLS0tLUJFR0lOIFBSSVZBVEUgS0VZLS0tLS1cbk1JSUV2Z0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktnd2dnU2tBZ0VBQW9JQkFRRGRUdXBDOUpDamlSeUlcblIyYWdtYVFVZlM4UE5HM2ZzalYrOWJNbFkzQXVBM2lybzVGRjNGdVJxMCs5MjdpcXJjVEJCRy9xYjJuUmZDOVlcbkFOTnpxNk9ySm9jUE1QelR4MXhYZG00dmg3aUtEaDFKMWZPc2l0dWxWYklPTnA2Tll6TWdRL1FCbzl2bWgwMG9cbjVCMjR0L3gzT0RaUWtBaUxCTEZZUUtZR2lBMkxmbit1Mno5VWNLazQrUGkrR2tYYWd1MHVkWnc4S205NDVwbEhcbk0zL25kckRmWk82aC9RSUs2SVlzOVMvU2ZBL1hETzdiRExRUUpJZklqZlRjOGhGOGhWTTh1QldRa1NQeUlSUE1cbmN0QUsrb3BaUFExK0FCVEdCSjdjYWhEa2o3d2k3clNIczZGMW8xaHByRGx3YUt3SUFhVm4yV0wyODR3Tmp5UkZcblIwNFRQcDJKQWdNQkFBRUNnZ0VBTlJNZ05Qc010aCtqcDE1Q1UxbE5nN2xyQUJGQm1ZQ1dlbEtJQ25zdzArUXlcbnZDMGY0YnFCZm11d2xkYWNVTmlZUTNjaU5QM1B5YlRuOE1uUDdHRjVRTXBlWVNzTk0yZ1FNZ3lkeThuWG5NcGFcblJWTXBtNU40cmt2aFJpM2N0QWxhb1U0U3RwTDY0YXhJdWJvTms3ZVNOWEJXZkZjeXFVNXdqcnNBWmpnYVVYM01cbmczQ24wOCtMTFhPeDRmUm9VekhwV2hlRmRxemltWGk4dDRHUytQSCtjakE5QzJmRExvL2t3M1dvdklnTHVqUG1cbmZHMmpYZXY5dUd0aC9QUUd2cHRUWUJNeTVGckF2cVMwUTdGNkZZRzg1dS9KRGE2bXh2bnFZajJRam4wdDBmcVRcbkZkN25PNDJvbUtkQnlWczF6OWtWajVzUE5xOFY4WTBDSVp6S0RhSGV4UUtCZ1FEeng4bW1JbXRZSk1yVFlZQ0dcbkU1ZFQ4NyttbFVTUmp1d1hnR2Y2a1UrYWh4N2RGYUVOWXBLbE1jMmdrVE8yMGZmTXc4bDJsMHNRTnZGYmw5TW1cbndJWUlpM3JUTkhWMVg2cmh1L3FCbS9lTllDSVQ3bWZxMmhtOE05a2pZdGVtQnpwNlVYbWpPSmFLcStoY3J6WDdcbjNoSWloRmdabEllWk9DSDdhTU9HbHM2NHRRS0JnUURvWnNNN3VGVVdLbkdZdU5KWVJTNEZBNWhGSUEvQUtJOGZcblN0Qzl6MnFLZ3NIczlJOUpEMWFvejQrM2xLR0tMMGxNenZxeWkwTFkyR1NWRC9EVTB6Ymk4dFpjZ1VaTkwweFJcbkpLaXJLUnBsTVNnckRFZE1wQjBQOWVYRk5LWTc0cUlWOUx1N2NWa1R3ZkgvcERHSWRRcGVDZGN1K2xoOW5Lc0xcbjNmaEJRMnc2QlFLQmdRRExiYi8vVEIrcHVXSXNET1EwZm1xOG10NG1ROCtwYTh2bVBMZ0lKM1IzTGlSNk40OWlcbjNRd2tvQy9JdXdLZG9BK2FKeE9hUzl4TzFwcUlaV1RGcE1qMG5uaExnUzQzV1RML0ZsK1FBcmdNbU5rM0txNDdcbkUrOS8xd0J2QUErV3M5ZC90VGU5RmY3Q0QzeGl3NjlYMDlQc1MrWTh5bTV4Vko4KzdnaWo2bnJ0TlFLQmdHdzFcbnBRUUNrVU92NFpLOXc5c3I0d0NjcXVMTXllaXNPZS9WRXhxK0lCcDhSYldDTGRGVDNnTGVHa25kWDlZS3JIT2lcbkVDTGdLdkR5Mk9wN01LUzM3OTkrT0lkNy9mTGthZ0dDTXpMM0FYNUtoQ3gvSEJlNGRudS9BQXh4dGxFOTlrQ0lcbjRueWxpMWRpdjc1TGduREtKbGlnOWx1K1gwT2xsaE1CZUoxU3Vtck5Bb0dCQUxJbTIwL0xIekw5OTZ0WktIeWVcblhnV3lFKyt1WkhVTEE2a094STFRU1hoc0VrYkt2aDZvZ2RaS0JuZG9iNk1nWk9LbGxsaVVXcEk1TVh2YTMrY09cbjFCcXRrRkNaMy9kM1BGd0xXSnhpbm9nelgwcWg1cTUreUtPM2pTZ1BtSHlHVzkzempHKzZaa1JoZnR1UnNmckJcbi94dTVOUkZTNjIrRitsRWFCTVR1cmtnQ1xuLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLVxuIiwKICAiY2xpZW50X2VtYWlsIjogImFwcC1lbmdpbmUtZ2l0aHViYWN0aW9uc0Bwb3N0bWFuLWRlbW8tMjY5ODEyLmlhbS5nc2VydmljZWFjY291bnQuY29tIiwKICAiY2xpZW50X2lkIjogIjExNzAxNzE1MjI0MTAwMTA3OTM4NyIsCiAgImF1dGhfdXJpIjogImh0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9vL29hdXRoMi9hdXRoIiwKICAidG9rZW5fdXJpIjogImh0dHBzOi8vb2F1dGgyLmdvb2dsZWFwaXMuY29tL3Rva2VuIiwKICAiYXV0aF9wcm92aWRlcl94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL29hdXRoMi92MS9jZXJ0cyIsCiAgImNsaWVudF94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL3JvYm90L3YxL21ldGFkYXRhL3g1MDkvYXBwLWVuZ2luZS1naXRodWJhY3Rpb25zJTQwcG9zdG1hbi1kZW1vLTI2OTgxMi5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIKfQo=
      with:
        args: app deploy services/products/app.yaml --no-promote --version=${{ env.GITHUB_REF_SLUG }}
